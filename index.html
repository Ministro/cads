<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cadastro com Planos</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <style>
    body {
      font-family: "Poppins", sans-serif;
      background-color: #f4f6f8;
      padding: 40px 20px;
      max-width: 800px;
      margin: auto;
    }
    h2 {
      color: #2c3e50;
      text-align: center;
      margin-bottom: 30px;
    }
    form {
      background: #fff;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    label {
      font-weight: 600;
      margin-top: 15px;
      display: block;
      color: #34495e;
    }
    input, select {
      padding: 10px;
      width: 100%;
      margin-top: 6px;
      border-radius: 8px;
      border: 1px solid #ccc;
      background-color: #f9f9f9;
      font-size: 14px;
      box-sizing: border-box;
    }
    button {
      margin-top: 30px;
      padding: 12px;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 8px;
      width: 100%;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #2980b9;
    }
    #info-instalacao {
      background-color: #eaf4fc;
      padding: 12px;
      border: 1px solid #d0e3f1;
      border-radius: 8px;
      margin-top: 20px;
      white-space: pre-line;
      display: none;
      color: #2c3e50;
    }
    #tipoPlanoContainer {
      display: none;
      margin-top: 15px;
    }
    #mapa {
      margin-top: 20px;
      height: 300px;
      border: 1px solid #ccc;
      border-radius: 10px;
    }
  </style>
</head>
<body>

  <h2>Formulário de Cadastro</h2>

  <form id="cadastroForm" autocomplete="off">
    <label for="nome">Nome completo</label>
    <input type="text" id="nome" name="nome" required />

    <label for="cpf">CPF</label>
    <input type="text" id="cpf" name="cpf" maxlength="14" placeholder="000.000.000-00" required />

    <label for="rg">RG</label>
    <input type="text" id="rg" name="rg" required />

    <label for="nascimento">Data de nascimento</label>
    <input type="text" id="nascimento" name="nascimento" maxlength="10" placeholder="dd/mm/aaaa" required />

    <label for="genero">Gênero</label>
    <select id="genero" name="genero" required>
      <option value="">Selecione</option>
      <option value="Masculino">Masculino</option>
      <option value="Feminino">Feminino</option>
    </select>

    <label for="Filiacaomae">Filiação Mãe</label>
    <input type="text" id="Filiacaomae" name="Filiacaomae" required />

    <label for="Filiacaopai">Filiação Pai</label>
    <input type="text" id="Filiacaopai" name="Filiacaopai" required />

    <label for="endereco">Endereço</label>
    <input type="text" id="endereco" name="endereco" required />

    <label for="bairro">Bairro</label>
    <input type="text" id="bairro" name="bairro" required />

    <label for="numero">Número da residência</label>
    <input type="text" id="numero" name="numero" required />

    <label for="referencia">Referência</label>
    <input type="text" id="referencia" name="referencia" required />

    <label for="moradia">Tipo de Moradia</label>
    <select id="moradia" name="moradia" required>
      <option value="">Selecione</option>
      <option value="Propria">Própria</option>
      <option value="Alugado">Alugada</option>
    </select>

    <label for="email">E-mail</label>
    <input type="email" id="email" name="email" />

    <label for="whatsapp">Número do WhatsApp</label>
    <input type="text" id="whatsapp" name="whatsapp" maxlength="15" placeholder="(00) 90000-0000" required />

    <label for="local">Localidade</label>
    <select id="local" name="local" required>
      <option value="">Selecione a localidade</option>
      <option value="Candeias">Candeias do Jamari</option>
      <option value="Setor chacareiro Cemitério/Candeias">Setor chacareiro Cemitério/Candeias</option>
      <option value="Green-PK">Green-PK</option>
      <option value="Pamus">Pamus</option>
      <option value="55A">55A</option>
      <option value="55B">55B</option>
      <option value="BR 364-Cuiba">BR 364-Cuiba</option>
      <option value="BR 364-PVH">BR 364-PVH</option>
      <option value="Rancho Alegre">Rancho Alegre</option>
      <option value="BR 364 (Cuiabá,Após o Silos)">BR 364 (Cuiabá,Após o Silos)</option>
      <option value="Corpo Dourado">Corpo Dourado</option>
      <option value="Santa Luzia">Santa Luzia</option>
      <option value="Setor Industrial PVH">Setor Industrial PVH</option>
      <option value="Bacia Leiteira Bom Jesus">Bacia Leiteira Bom Jesus</option>
      <option value="Bacia Leiteira Ramal do Boto">Bacia Leiteira Ramal do Boto</option>
      <option value="Bairro 13/ Castanheiras">Bairro 13/ Castanheiras</option>
      <option value="Piquiá">3 Piquiás</option>
      <option value="Bairro Novo de Candeias">Bairro Novo de Candeias</option>
      <option value="Linha do Caju">Linha do Caju</option>
    </select>

    <div id="tipoPlanoContainer">
      <label for="tipoPlano">Tipo de Plano</label>
      <select id="tipoPlano" name="tipoPlano">
        <option value="">Selecione</option>
        <option value="Com Fidelidade">Com Fidelidade</option>
        <option value="Sem Fidelidade">Sem Fidelidade</option>
      </select>
    </div>

    <label for="plano">Plano</label>
    <select id="plano" name="plano" required>
      <option value="">Selecione o plano</option>
    </select>

    <label for="indicacao">Indicação</label>
    <select id="indicacao" name="indicacao" required>
      <option value="">Selecione</option>
      <option value="Sem Indicação">Sem Indicação</option>
      <option value="Gilsepe Castro">Gilsepe Castro</option>
      <option value="Mayron Sodré">Mayron Sodré</option>
      <option value="Wesley Ribeiro">Wesley Ribeiro</option>
    </select>

    <label for="vencimento">Dia do Vencimento</label>
    <select id="vencimento" name="vencimento" required>
      <option value="">Selecione</option>
      <option value="05">05</option>
      <option value="10">10</option>
      <option value="15">15</option>
      <option value="20">20</option>
      <option value="25">25</option>
      <option value="30">30</option>
    </select>

    <input type="hidden" id="latitude" name="latitude" />
    <input type="hidden" id="longitude" name="longitude" />

    <button type="submit">Enviar Cadastro</button>
  </form>

  <div id="info-instalacao"></div>
  <div id="mapa"></div>

  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script>
    const dadosPorLocal = {
      Candeias: {
        instalacao: "Com fidelidade: grátis (mediante consulta de CPF).\nSem fidelidade: R$ 200,00 no ato da instalação.",
        planos: {
          "200MB": "109,99",
          "400MB": "134,99",
          "600MB": "149,99",
          "800MB": "169,99",
          "1000MB": "219,99",
        },
        obs: "Com fidelidade: contrato de 12 meses e instalação gratuita após aprovação na consulta de CPF.\nSem fidelidade: instalação custa R$ 200,00 e o cliente pode cancelar a qualquer momento.",
      },
      "Setor chacareiro Cemitério/Candeias": {
        instalacao: "350,00 à vista/ R$450,00 Parcelado",
        planos: { "100MB": "149,99", "200MB": "169,99", "300MB": "184,99" },
        obs: "R$450,00 Instalação parcelado com entrada de R$200,00",
      },
      // ... demais localidades, mantenha como antes ...
    };

    // Máscaras
    function mascaraCPF(valor) {
      return valor
        .replace(/\D/g, "")
        .replace(/(\d{3})(\d)/, "$1.$2")
        .replace(/(\d{3})(\d)/, "$1.$2")
        .replace(/(\d{3})(\d{1,2})$/, "$1-$2");
    }

    function mascaraWhatsApp(valor) {
      return valor
        .replace(/\D/g, "")
        .replace(/(\d{2})(\d)/, "($1) $2")
        .replace(/(\d{1})(\d{4})(\d)/, "$1$2-$3");
    }

    function mascaraData(valor) {
      return valor
        .replace(/\D/g, "")
        .replace(/(\d{2})(\d)/, "$1/$2")
        .replace(/(\d{2})(\d)/, "$1/$2")
        .replace(/(\d{4})(\d)/, "$1");
    }

    function validarCPF(cpf) {
      cpf = cpf.replace(/[^\d]+/g, "");
      if (cpf.length !== 11 || /^(\d)\1+$/.test(cpf)) return false;

      let soma = 0;
      for (let i = 0; i < 9; i++) soma += parseInt(cpf.charAt(i)) * (10 - i);
      let resto = (soma * 10) % 11;
      if (resto === 10 || resto === 11) resto = 0;
      if (resto !== parseInt(cpf.charAt(9))) return false;

      soma = 0;
      for (let i = 0; i < 10; i++) soma += parseInt(cpf.charAt(i)) * (11 - i);
      resto = (soma * 10) % 11;
      if (resto === 10 || resto === 11) resto = 0;
      if (resto !== parseInt(cpf.charAt(10))) return false;

      return true;
    }

    // Atualiza planos e info instalação conforme local
    const planoSelect = document.getElementById("plano");
    const localSelect = document.getElementById("local");
    const tipoPlanoContainer = document.getElementById("tipoPlanoContainer");
    const tipoPlanoSelect = document.getElementById("tipoPlano");
    const infoInstalacaoDiv = document.getElementById("info-instalacao");

    localSelect.addEventListener("change", () => {
      const local = localSelect.value;
      planoSelect.innerHTML = "<option value=''>Selecione o plano</option>";
      infoInstalacaoDiv.style.display = "none";
      tipoPlanoContainer.style.display = "none";
      tipoPlanoSelect.value = "";

      if (!local) return;

      if (dadosPorLocal[local]) {
        infoInstalacaoDiv.style.display = "block";
        infoInstalacaoDiv.textContent =
          "Instalação:\n" + dadosPorLocal[local].instalacao;
        if (dadosPorLocal[local].obs) {
          infoInstalacaoDiv.textContent += "\n\nObservações:\n" + dadosPorLocal[local].obs;
        }

        const planos = dadosPorLocal[local].planos;
        for (const plano in planos) {
          const option = document.createElement("option");
          option.value = plano;
          option.textContent = `${plano} - R$${planos[plano]}`;
          planoSelect.appendChild(option);
        }

        if (local === "Candeias") {
          tipoPlanoContainer.style.display = "block";
        }
      }
    });

    // Máscaras inputs
    document.getElementById("cpf").addEventListener("input", (e) => {
      e.target.value = mascaraCPF(e.target.value);
    });
    document.getElementById("whatsapp").addEventListener("input", (e) => {
      e.target.value = mascaraWhatsApp(e.target.value);
    });
    document.getElementById("nascimento").addEventListener("input", (e) => {
      e.target.value = mascaraData(e.target.value);
    });

    // Mapa Leaflet para pegar localização
    const mapa = L.map("mapa").setView([-8.7622, -63.9019], 10);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "© OpenStreetMap contributors",
    }).addTo(mapa);

    let marker;

    function setMarker(lat, lng) {
      if (marker) mapa.removeLayer(marker);
      marker = L.marker([lat, lng]).addTo(mapa);
      mapa.setView([lat, lng], 15);
      document.getElementById("latitude").value = lat;
      document.getElementById("longitude").value = lng;
    }

    mapa.on("click", (e) => {
      setMarker(e.latlng.lat, e.latlng.lng);
    });

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          setMarker(pos.coords.latitude, pos.coords.longitude);
        },
        () => {
          console.log("Não foi possível pegar a localização automática");
        }
      );
    }

    // Função para enviar dados ao Airtable usando async/await
    async function enviarCadastro(dados) {
      const AIRTABLE_URL = "https://api.airtable.com/v0/appGuthPd5hJXUGYQ/tblXma0echbQ1r0i5";
      const AIRTABLE_TOKEN = "patOhxV7DCQSBAnN4.bebf08508f71dfead6a6ea418933083311a9714e748b59868716bb68d95e02a8";

      const response = await fetch(AIRTABLE_URL, {
        method: "POST",
        headers: {
          Authorization: `Bearer ${AIRTABLE_TOKEN}`,
          "Content-Type": "application/json",
        },
        body: JSON.stringify(dados),
      });

      if (!response.ok) {
        const erroTexto = await response.text();
        throw new Error(`Erro Airtable: ${response.status} - ${erroTexto}`);
      }

      return await response.json();
    }

    // Função para enviar mensagem ao Telegram
    async function enviarTelegram(nome, cpf, plano, local) {
      const BOT_TOKEN = "7782501693:AAHMgA1J_mvPr-toayUMoWb-8WCHQZEjLSI";
      const CHAT_ID = "-4945584051"; // seu grupo ou chat

      const mensagem = `Novo cadastro recebido:
Nome: ${nome}
CPF: ${cpf}
Plano: ${plano}
Localidade: ${local}`;

      const url = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage?chat_id=${CHAT_ID}&text=${encodeURIComponent(mensagem)}`;

      const res = await fetch(url);
      if (!res.ok) {
        const errText = await res.text();
        throw new Error(`Erro Telegram: ${res.status} - ${errText}`);
      }
    }

    // Evento submit do formulário
    const form = document.getElementById("cadastroForm");

    form.addEventListener("submit", async (event) => {
      event.preventDefault();

      // Validação CPF
      const cpfVal = form.cpf.value;
      if (!validarCPF(cpfVal)) {
        alert("CPF inválido. Por favor, verifique e tente novamente.");
        form.cpf.focus();
        return;
      }

      // Monta dados para Airtable
      const dados = {
        records: [
          {
            fields: {
              Nome: form.nome.value,
              CPF: form.cpf.value,
              RG: form.rg.value,
              Nascimento: form.nascimento.value,
              Genero: form.genero.value,
              Filiacaomae: form.Filiacaomae.value,
              Filiacaopai: form.Filiacaopai.value,
              Endereco: form.endereco.value,
              Bairro: form.bairro.value,
              Numero: form.numero.value,
              Referencia: form.referencia.value,
              Moradia: form.moradia.value,
              Email: form.email.value,
              WhatsApp: form.whatsapp.value,
              Localidade: form.local.value,
              TipoPlano: form.tipoPlano.value,
              Plano: form.plano.value,
              Indicacao: form.indicacao.value,
              Vencimento: form.vencimento.value,
              Latitude: form.latitude.value,
              Longitude: form.longitude.value,
            },
          },
        ],
      };

      try {
        await enviarCadastro(dados);
        await enviarTelegram(
          form.nome.value,
          form.cpf.value,
          form.plano.value,
          form.local.value
        );
        alert("Cadastro enviado com sucesso!");
        form.reset();
        infoInstalacaoDiv.style.display = "none";
        tipoPlanoContainer.style.display = "none";
        if (marker) {
          mapa.removeLayer(marker);
          marker = null;
        }
      } catch (error) {
        alert("Erro ao enviar cadastro: " + error.message);
        console.error(error);
      }
    });
  </script>
</body>
</html>
